<!-- Members Directory Template -->
<?php
// Group members by team for initial display
$membersByTeam = [];
foreach ($members as $member) {
    $teamKey = !empty($member['team_nom']) ? $member['team_nom'] : 'Sans équipe';
    if (!isset($membersByTeam[$teamKey])) {
        $membersByTeam[$teamKey] = [];
    }
    $membersByTeam[$teamKey][] = $member;
}

// Sort teams: named teams first (alphabetically), then "Sans équipe"
ksort($membersByTeam);
if (isset($membersByTeam['Sans équipe'])) {
    $noTeam = $membersByTeam['Sans équipe'];
    unset($membersByTeam['Sans équipe']);
    $membersByTeam['Sans équipe'] = $noTeam;
}
?>

<section class="members-directory-section">
    <h1 class="section-title">Annuaire des Membres</h1>
    
    <!-- Search and Filter Bar -->
    <div class="members-filter-bar">
        <div class="filter-group">
            <label for="member-search">Rechercher:</label>
            <input type="text" 
                   id="member-search" 
                   class="form-control" 
                   placeholder="Nom, prénom...">
        </div>
        
        <div class="filter-group">
            <label for="filter-team">Équipe:</label>
            <select id="filter-team" class="form-control">
                <option value="all">Toutes les équipes</option>
                <?php if (!empty($teams)): ?>
                    <?php foreach ($teams as $team): ?>
                        <option value="<?= (int)$team['id_team'] ?>">
                            <?= $this->escape($team['nom']) ?>
                        </option>
                    <?php endforeach; ?>
                <?php endif; ?>
                <option value="0">Sans équipe</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filter-grade">Grade:</label>
            <select id="filter-grade" class="form-control">
                <option value="all">Tous les grades</option>
                <?php if (!empty($grades)): ?>
                    <?php foreach ($grades as $grade): ?>
                        <option value="<?= $this->escape($grade) ?>">
                            <?= $this->escape($grade) ?>
                        </option>
                    <?php endforeach; ?>
                <?php endif; ?>
            </select>
        </div>

        <div class="filter-group">
            <label for="sort-column">Trier par:</label>
            <select id="sort-column" class="form-control">
                <option value="name">Nom</option>
                <option value="team">Équipe</option>
                <option value="grade">Grade</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sort-order">Ordre:</label>
            <select id="sort-order" class="form-control">
                <option value="asc">A-Z</option>
                <option value="desc">Z-A</option>
            </select>
        </div>
        
        <div class="filter-actions">
            <button type="button" id="reset-filters" class="btn btn-secondary">
                Réinitialiser
            </button>
        </div>
    </div>
    
    <!-- Results Count -->
    <div class="results-info">
        <span id="results-count"><?= count($members) ?></span> membre(s) trouvé(s)
    </div>
    
    <?php if (!empty($members)): ?>
        <div class="members-table-container">
            <table class="members-table" id="members-table">
                <thead>
                    <tr>
                        <th>Équipe</th>
                        <th>Nom Complet</th>
                        <th>Grade</th>
                    </tr>
                </thead>
                <tbody id="members-tbody">
                    <?php foreach ($membersByTeam as $teamName => $teamMembers): ?>
                        <?php 
                        $memberCount = count($teamMembers);
                        $isFirstMember = true;
                        ?>
                        <?php foreach ($teamMembers as $member): ?>
                            <tr class="member-row"
                                data-name="<?= $this->escape(strtolower($member['prenom'] . ' ' . $member['nom'])) ?>"
                                data-team-id="<?= (int)($member['id_team'] ?? 0) ?>"
                                data-team-name="<?= $this->escape(strtolower($member['team_nom'] ?? 'sans équipe')) ?>"
                                data-grade="<?= $this->escape(strtolower($member['grade'])) ?>"
                                data-member-data='<?= json_encode([
                                    "prenom" => $member["prenom"],
                                    "nom" => $member["nom"],
                                    "grade" => $member["grade"],
                                    "team_nom" => $member["team_nom"] ?? null,
                                    "id_team" => $member["id_team"] ?? 0,
                                    "is_team_leader" => $member["is_team_leader"] ?? 0
                                ]) ?>'>
                                <?php if ($isFirstMember): ?>
                                    <?php if ($teamName === 'Sans équipe'): ?>
                                        <td class="team-cell"><?= $this->escape($teamName) ?></td>
                                    <?php else: ?>
                                        <td class="team-cell" rowspan="<?= $memberCount ?>"><?= $this->escape($teamName) ?></td>
                                    <?php endif; ?>
                                    <?php $isFirstMember = false; ?>
                                <?php elseif ($teamName === 'Sans équipe'): ?>
                                    <td class="team-cell"><?= $this->escape($teamName) ?></td>
                                <?php endif; ?>
                                <td>
                                    <?= $this->escape($member['prenom'] . ' ' . $member['nom']) ?>
                                    <?php if (!empty($member['is_team_leader'])): ?>
                                        <span class="team-leader-badge">(chef d'équipe)</span>
                                    <?php endif; ?>
                                </td>
                                <td><?= $this->escape($member['grade']) ?></td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <div id="no-results-message" class="no-results" style="display: none;">
            Aucun membre ne correspond à vos critères de recherche.
        </div>
    <?php else: ?>
        <p class="no-results">Aucun membre n'est disponible pour le moment.</p>
    <?php endif; ?>
</section>
